<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>書籍データ登録</title>
    <style>
        body {
            font-family: sans-serif;
        }

        h1 {
            text-align: center;
        }

        form {
            width: 500px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
        }

        label {
            display: inline-block;
            width: 100px;
            text-align: right;
            margin-right: 10px;
        }

        input[type="text"],
        input[type="number"] {
            width: 300px;
            padding: 5px;
            border: 1px solid #ccc;
        }
        /* Readonly fields style - No longer needed for category, but kept for potential future use */
        input[readonly] {
            background-color: #eee;
        }


        button[type="button"] { /* Specificity increased */
            padding: 5px 10px;
            margin-left: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button[type="submit"] { /* Style for the register button */
             display: block;
             width: 100px;
             margin: 20px auto;
             padding: 10px;
             background-color: #4CAF50;
             color: white;
             border: none;
             cursor: pointer;
        }


        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>書籍データ登録</h1>

    <form id="bookForm">
        <label for="isbn">ISBN:</label>
        <input type="text" id="isbn" name="isbn" style="ime-mode: inactive;"> <!-- 初期入力を半角に -->
        <button type="button" onclick="fetchBookInfo()">書籍情報取得</button>
        <!-- 書影表示エリア -->
        <div id="thumbnailContainer" style="margin-top: 10px; text-align: center; min-height: 150px;">
            <img id="bookThumbnail" src="" alt="書影" style="max-width: 100px; max-height: 150px; display: none; border: 1px solid #ccc;">
            <p id="thumbnailMessage" style="display: none; margin-top: 5px; font-size: 0.9em; color: #666;"></p>
        </div>
        <br><br>

        <label for="title">タイトル:</label>
        <input type="text" id="title" name="title"><br><br>

        <label for="author">著者:</label>
        <input type="text" id="author" name="author"><br><br>

        <label for="publisher">出版社:</label>
        <input type="text" id="publisher" name="publisher" style="ime-mode: active;"><br><br>

        <label for="issueYear">発行年:</label>
        <input type="text" id="issueYear" name="issueYear"><br><br>

        <label for="price">価格:</label>
        <input type="number" id="price" name="price"><br><br>

        <label for="category">書籍分類:</label>
        <input type="text" id="category" name="category"><br><br>

        <button type="submit" onclick="registerBook(event)">登録</button> 
    </form>

    <h2>登録データ一覧</h2>
    <table id="bookTable">
        <thead>
            <tr>
                <th>InstanceID</th>
                <th>ISBN</th>
                <th>タイトル</th>
                <th>著者</th>
                <th>出版社</th>
                <th>発行年</th>
                <th>価格</th>
                <th>書籍分類</th> 
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // 国立国会図書館サーチAPIから書籍情報を取得する関数
        async function fetchBookInfo() {
            const isbn = document.getElementById("isbn").value.replace(/-/g, ''); // ハイフンを除去
            if (!isbn) {
                alert("ISBNを入力してください。");
                return;
            }

            // API実行前にフォームをクリア（ISBN以外）
            document.getElementById("title").value = "";
            document.getElementById("author").value = "";
            document.getElementById("publisher").value = "";
            document.getElementById("issueYear").value = "";
            document.getElementById("price").value = "";
            document.getElementById("category").value = "";

            // 書影表示エリアをクリア
            document.getElementById("bookThumbnail").style.display = "none";
            document.getElementById("bookThumbnail").src = "";
            document.getElementById("thumbnailMessage").style.display = "none";
            document.getElementById("thumbnailMessage").textContent = "";


            // SRU API のベース URL とパラメータ
            const baseUrl = "https://ndlsearch.ndl.go.jp/api/sru";
            const params = new URLSearchParams({
                operation: "searchRetrieve",
                version: "1.2",
                recordSchema: "dcndl", // DC-NDLスキーマを指定
                onlyBib: "true",
                recordPacking: "xml",
                // CQL クエリ: ISBN で検索し、データソースを NDL-OPAC に限定
                query: `isbn="${isbn}" AND dpid="iss-ndl-opac"`
            });
            const apiUrl = `${baseUrl}?${params.toString()}`;
            console.log("Request URL (SRU):", apiUrl); // デバッグ用にURLを出力

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");

                // 名前空間を解決するためのヘルパー関数 (SRU/DC-NDL 用に修正)
                const nsResolver = (prefix) => {
                    const ns = {
                        'sru': 'http://www.loc.gov/zing/srw/', // SRU 名前空間
                        'rdf': 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
                        'dcndl': 'http://ndl.go.jp/dcndl/terms/', // DC-NDL 名前空間
                        'dc': 'http://purl.org/dc/elements/1.1/',
                        'dcterms': 'http://purl.org/dc/terms/',
                        // 必要に応じて他の名前空間を追加
                    };
                    // デフォルト名前空間は SRU レスポンスでは通常不要なため削除
                    return ns[prefix] || null;
                };

                // XPathを使用して要素や属性を取得するヘルパー関数
                const evaluateXPath = (path, contextNode = xmlDoc, resultType = XPathResult.FIRST_ORDERED_NODE_TYPE) => {
                    return xmlDoc.evaluate(path, contextNode, nsResolver, resultType, null);
                };
                 const evaluateXPathAll = (path, contextNode = xmlDoc) => {
                    // Use ORDERED_NODE_ITERATOR_TYPE for iterating through multiple nodes
                    return xmlDoc.evaluate(path, contextNode, nsResolver, XPathResult.ORDERED_NODE_ITERATOR_TYPE, null);
                };


                // 書籍リソース要素を取得 (SRU/DC-NDL形式を想定)
                // SRUレスポンスの構造に合わせてXPathを修正
                const bibResourceNode = evaluateXPath("//sru:recordData/rdf:RDF/dcndl:BibResource", xmlDoc).singleNodeValue;

                if (!bibResourceNode) { // bibResourceNode をチェック
                    alert("該当する書籍情報が見つかりませんでした。");
                    return;
                }
                // 以降のXPathはこの bibResourceNode を基点にする
                const item = bibResourceNode; // 変数名を合わせる (もしくは bibResourceNode のまま使う)

                if (!item) {
                    alert("該当する書籍情報が見つかりませんでした。");
                    return;
                }

                // 各情報をXPathで取得 (DC-NDL スキーマに合わせて修正)
                // 注意: dcndl:BibResource (item) を基点とするため、XPath の先頭に '.' を付ける
                const titleNode = evaluateXPath("./dc:title", item).singleNodeValue;
                // 著者情報は dcndl:creator や dc:creator を確認 (複数ある可能性も考慮)
                const authorNode = evaluateXPath("./dcndl:creator | ./dc:creator", item).singleNodeValue; // まず最初のものを取得
                // 出版社取得の XPath をシンプルに変更
                const publisherNode = evaluateXPath("./dcterms:publisher", item).singleNodeValue;
                const issuedNode = evaluateXPath("./dcterms:issued", item).singleNodeValue; // 発行年 (YYYY または YYYY-MM-DD)
                const priceNode = evaluateXPath("./dcndl:price", item).singleNodeValue; // 価格

                // タイトル取得時に trim() と改行での分割を適用して本体のみ抽出
                const fullTitleText = titleNode?.textContent || "";
                console.log("Raw Title Text:", fullTitleText); // 元のテキストをログ出力
                // 改行で分割し、空でない最初の行を取得して trim()
                const title = fullTitleText.split('\n')
                                           .map(part => part.trim()) // 各行を trim
                                           .find(part => part !== '') || ""; // 空でない最初の行を見つける
                console.log("Processed Title:", title); // 処理後のタイトルをログ出力
                const author = authorNode?.textContent || ""; // 著者 (最初のもの)
                console.log("Author:", author);
                // 出版社名取得時に trim() と改行での分割を適用して本体のみ抽出
                const fullPublisherText = publisherNode?.textContent || "";
                console.log("Raw Publisher Text:", fullPublisherText); // 元のテキストをログ出力
                // 改行で分割し、空でない最初の行を取得して trim()
                const publisher = fullPublisherText.split('\n')
                                                   .map(part => part.trim()) // 各行を trim
                                                   .find(part => part !== '') || ""; // 空でない最初の行を見つける
                console.log("Processed Publisher:", publisher); // 処理後の出版社名をログ出力
                const issued = issuedNode?.textContent || "";
                const issueYear = issued.match(/^\d{4}/)?.[0] || ""; // YYYY または YYYY-MM-DD から年のみ抽出
                console.log("Issue Year:", issueYear);

                // --- 書籍分類 (NDC) 取得ロジック (XPath の基点を修正) ---
                let category = "";
                // XPath の基点を item (dcndl:BibResource) に変更
                const subjectIterator = evaluateXPathAll("./dcterms:subject[starts-with(@rdf:resource, 'http://id.ndl.go.jp/class/ndc10/') or starts-with(@rdf:resource, 'http://id.ndl.go.jp/class/ndc9/')]", item);
                console.log("Subject Iterator:", subjectIterator);
                let subjectNode;
                console.log("Attempting to iterate subjects...");
                while (subjectNode = subjectIterator.iterateNext()) {
                    console.log("Iterating a subject node...");
                    const resourceAttr = subjectNode.getAttributeNS('http://www.w3.org/1999/02/22-rdf-syntax-ns#', 'resource');
                    console.log("Resource Attribute:", resourceAttr);
                    if (resourceAttr) {
                        const parts = resourceAttr.split('/');
                        console.log("Resource Parts:", parts);
                        const ndcCode = parts[parts.length - 1];
                        console.log("NDC Code:", ndcCode);
                        if (ndcCode && /^\d/.test(ndcCode)) {
                            category = ndcCode.charAt(0);
                            console.log("Extracted Category:", category);
                            break;
                        }
                    }
                }
                // --- 書籍分類取得ロジックここまで ---

                // 価格 (空なら0)
                let price = 0;
                const priceValue = priceNode?.textContent || "";
                console.log("Price Value:", priceValue);
                if (priceValue !== "") {
                    // 価格文字列から数値のみを抽出 (例: "1800円" -> 1800)
                    const priceMatch = priceValue.match(/\d+/);
                    if (priceMatch) {
                        const parsedPrice = parseInt(priceMatch[0], 10);
                        if (!isNaN(parsedPrice)) {
                            price = parsedPrice;
                        }
                    }
                }
                console.log("Parsed Price:", price);


                // フォームに値を設定
                document.getElementById("title").value = title;
                document.getElementById("author").value = author;
                document.getElementById("publisher").value = publisher;
                document.getElementById("issueYear").value = issueYear;
                document.getElementById("category").value = category; // Set category from extracted NDC first digit
                document.getElementById("price").value = price; // Set price

                // --- 書影表示処理 ---
                const thumbnailImg = document.getElementById("bookThumbnail");
                const thumbnailMsg = document.getElementById("thumbnailMessage");
                const thumbnailUrl = `https://ndlsearch.ndl.go.jp/thumbnail/${isbn}.jpg`;

                // 画像が存在するか確認 (onerror イベントを利用)
                thumbnailImg.onload = () => {
                    thumbnailImg.style.display = "block"; // 画像を表示
                    thumbnailMsg.style.display = "none"; // メッセージを非表示
                    thumbnailMsg.textContent = "";
                };
                thumbnailImg.onerror = () => {
                    thumbnailImg.style.display = "none"; // 画像を非表示
                    thumbnailMsg.style.display = "block"; // メッセージを表示
                    thumbnailMsg.textContent = "書影が見つかりません。";
                };
                // 既存の src をクリアしてから新しい URL を設定 (キャッシュ対策)
                thumbnailImg.src = "";
                thumbnailImg.src = thumbnailUrl; // 画像 URL を設定 (これで onload or onerror がトリガーされる)
                // --- 書影表示処理ここまで ---


            } catch (error) {
                console.error("書籍情報の取得に失敗しました:", error);
                alert("書籍情報の取得中にエラーが発生しました。");
                // エラー時も書影エリアをリセット
                document.getElementById("bookThumbnail").style.display = "none";
                document.getElementById("bookThumbnail").src = "";
                document.getElementById("thumbnailMessage").style.display = "none";
                document.getElementById("thumbnailMessage").textContent = "";
            }
        }

        // 書籍データを登録する関数
        function registerBook(event) {
            event.preventDefault(); // Prevent default form submission

            const isbn = document.getElementById("isbn").value;
            const title = document.getElementById("title").value;
            const author = document.getElementById("author").value;
            const publisher = document.getElementById("publisher").value;
            const issueYear = document.getElementById("issueYear").value;
            const price = document.getElementById("price").value;
            const category = document.getElementById("category").value; // Get category

            // 入力値の検証
            if (!isbn) {
                alert("ISBNを入力してください（書籍情報取得ボタンを押すか、手動で入力してください）。");
                return;
            }
             // 価格が入力されていれば数値かチェック (APIで0が入る可能性もあるので必須ではない)
            if (price && isNaN(price)) {
                alert("価格は数値で入力してください。");
                return;
            }
             if (issueYear && isNaN(issueYear)) { // 発行年が入力されていれば数値かチェック
                 alert("発行年は数値で入力してください。");
                 return;
             }


            // InstanceIDを生成
            const instanceID = generateInstanceID();

            // データをlocalStorageに保存 (categoryも渡す)
            saveBookData(instanceID, isbn, title, author, publisher, issueYear, price, category);

            // テーブルにデータを表示
            displayBookData();

            // フォームをクリア
            clearForm();
        }

        function generateInstanceID() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}_${hour}${minute}${second}`;
        }

        // saveBookData に category 引数を追加
        function saveBookData(instanceID, isbn, title, author, publisher, issueYear, price, category) {
            const bookData = {
                isbn: isbn,
                title: title,
                author: author,
                publisher: publisher,
                issueYear: issueYear,
                price: price,
                category: category // category を保存
            };
            localStorage.setItem(instanceID, JSON.stringify(bookData));
        }

        function displayBookData() {
            const bookTable = document.getElementById("bookTable").getElementsByTagName('tbody')[0];
            bookTable.innerHTML = ""; // テーブルをクリア

            // localStorageからキーを取得し、ソートする（InstanceID順にするため）
            const keys = Object.keys(localStorage).sort();

            for (const instanceID of keys) {
                // キーが InstanceID の形式（YYMMDD_HHMMSS）か簡易チェック
                if (!/^\d{6}_\d{6}$/.test(instanceID)) {
                    continue; // InstanceID 形式でなければスキップ
                }
                try {
                    const bookData = JSON.parse(localStorage.getItem(instanceID));
                     // bookData が null でないこと、および必要なプロパティを持つことを確認
                    if (bookData && typeof bookData === 'object' && 'isbn' in bookData) {
                        const newRow = bookTable.insertRow();
                        const instanceIDCell = newRow.insertCell();
                        const isbnCell = newRow.insertCell();
                        const titleCell = newRow.insertCell();
                        const authorCell = newRow.insertCell();
                        const publisherCell = newRow.insertCell();
                        const issueYearCell = newRow.insertCell();
                        const priceCell = newRow.insertCell();
                        const categoryCell = newRow.insertCell(); // category セルを追加

                        instanceIDCell.innerHTML = instanceID;
                        isbnCell.innerHTML = bookData.isbn || ""; // データがない場合は空文字
                        titleCell.innerHTML = bookData.title || "";
                        authorCell.innerHTML = bookData.author || "";
                        publisherCell.innerHTML = bookData.publisher || "";
                        issueYearCell.innerHTML = bookData.issueYear || "";
                        priceCell.innerHTML = bookData.price || "";
                        categoryCell.innerHTML = bookData.category || ""; // category を表示
                    } else {
                         console.warn(`Invalid book data found for key: ${instanceID}`);
                    }
                } catch (e) {
                    console.error(`Error parsing localStorage item with key ${instanceID}:`, e);
                }
            }
        }

        // clearForm に category フィールドのクリアを追加
        function clearForm() {
            document.getElementById("isbn").value = "";
            document.getElementById("title").value = "";
            document.getElementById("author").value = "";
            document.getElementById("publisher").value = "";
            document.getElementById("issueYear").value = "";
            document.getElementById("price").value = "";
            document.getElementById("category").value = ""; // category もクリア
            // 書影表示エリアをリセット
            document.getElementById("bookThumbnail").style.display = "none";
            document.getElementById("bookThumbnail").src = "";
            document.getElementById("thumbnailMessage").style.display = "none";
            document.getElementById("thumbnailMessage").textContent = "";
        }

        // ページ読み込み時にデータを表示
        window.onload = function() {
            // addInitialData(); // 初期データ投入はコメントアウト
            displayBookData();
        };

    </script>
</body>
</html>