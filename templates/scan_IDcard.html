<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
 "http://www.w3.org/TR/html4/loose.dtd">
<html>
<meta http-equiv="content-type" content="text/html; charset=shift_jis">
<head>
 <title>Get Mail Address</title>
 <style>
  .back-button {
   position: absolute;
   bottom: 40px;
   left: 40px;
  }
 </style>
</head>
<body>
    <button type="button" id="gotoMainMenu2" class="btn btn-small back-button">戻る</button>
    <script src="/static/js/navigation.js" defer></script>
</body>
<body>
 <h3>
  <div class="header-title">
   Get mail address from employee card
  </div>
 </h3>

  <div class="mainArea">
    <!--<div class="button1">
      <span class="col-1" style="display: inline-block; width: 800px">Reading a FeliCa Card (ICS-E008/10 : Sample 5 Format)</span>
      <button id="FeliCa">Execute</button>
    </div>

    <br><br>-->
    <div class="detect">
      <div id="detect-title" class="detect-title" style="display: inline;"></div><br>
      <div id="detect" class="detect-info" style="display: inline;"></div>
    </div>
    <br>
  <div class="communicate">
   <div id="communicate-title" class="communicate-title" style="display: inline;"></div><br>
   <div id="communicate" class="communicate-response" style="display: inline;"></div><br>
    <div id="communicate-message" class="communicate-response" style="display: inline;"></div>
  </div>
 </div>

<img src="/static/images/IDCardTouchRequest.jpg" alt="ID Card Touch Request" class="centered-image">     
<!-- 共通カスタムメッセージボックスをインクルード -->
    {% include 'my_messagebox.html' %}

<script type='module'>
 import {NFCPortLib, NFCPortError, Configuration, DetectionOption, CommunicationOption, TargetCard} from 'https://cdn.felica-support.sony.biz/webclient/trial/NFCPortLib.js';
 let detectTitle = document.getElementById('detect-title');
 let detectMessage = document.getElementById('detect');
 let communicateTitle = document.getElementById('communicate-title');
 let communicateMessage = document.getElementById('communicate');
 let communicateMessage2 = document.getElementById('communicate-message');

 document.addEventListener('DOMContentLoaded', function() {
   felica_card();
 });


 async function felica_card() {
  console.log('[Reading a FeliCa Card] Begin');
  let lib = null;
  let ret = null;
  detectTitle.innerText = '';
  detectMessage.innerText = '';
  communicateTitle.innerText = '';
  communicateMessage.innerText = '';

  const startTime = Date.now(); // 開始時刻を取得


  do {
    let GID = '';
    let kanaName = '';

    // タイムアウト判定 (20秒 = 20000ミリ秒)
    if (Date.now() - startTime > 20000) {
      console.log('Timeout: Card not detected within 20 seconds.');
      detectTitle.innerText = '社員証が検出されませんでした。';
      // OKボタンを表示
      const okButton = document.createElement('button');
      okButton.innerText = 'OK';
      okButton.onclick = function() {
        window.location.href = '/'; // メインメニューへ遷移
      };
      detectMessage.appendChild(okButton);
      break; // ループを終了
    }

    try{
   /* create NFCPortLib object */
   lib = new NFCPortLib();

   /* init() */
   let config = new Configuration(500 /* ackTimeout */, 500 /* receiveTimeout */, true /* autoBaudRate*/, true /* autoDeviceSelect */);
   await lib.init(config);
   /* open() */
   await lib.open();
   console.log('deviceName : ' + lib.deviceName);

   /* detectCard(FeliCa Card) */
   let detectOption = new DetectionOption(new Uint8Array([0xff, 0xff]), 0, true, false, null);
   let card = await lib.detectCard('iso18092', detectOption)
   .then(ret => {
    detectTitle.innerText = 'Card is detected';
    if (ret.systemCode == null) {
     console.log('IDm : ' + _array_tohexs(ret.idm) +
         '\nPMm : ' + _array_tohexs(ret.pmm) +
         '\ntargetCardBaudRate : ' + lib.targetCardBaudRate + 'kbps');
    } else {
     console.log('IDm : ' + _array_tohexs(ret.idm) +
         '\nPMm : ' + _array_tohexs(ret.pmm) +
         '\nSystemCode : ' + _array_tohexs(ret.systemCode) +
         '\ntargetCardBaudRate : ' + lib.targetCardBaudRate + 'kbps');
    }
    //detectMessage.innerText = 'IDm : ' + _array_tohexs(ret.idm);
    return ret;
   }, (error) => {
    detectTitle.innerText = 'Card is not detected';
    throw(error);
   });

   /* communicateThru(Read Block) */
   let felica_read_without_encryption1 = new Uint8Array([16, 0x06, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 1, 0x0b, 0x02, 1, 0x80,0x00]); //社員番号ブロック取得
            _array_copy(felica_read_without_encryption1, 2, card.idm, 0, card.idm.length);
   let response1 = await lib.communicateThru(felica_read_without_encryption1, 100, detectOption)
   .then(ret1 => {
    //communicateTitle.innerText = 'Reading...';
    console.log(/*communicateMessage.innerText =*/ 'Send    : ' + _array_tohexs(felica_read_without_encryption1) +
                 '\nReceive : ' + _array_tohexs(ret1));
    GID = _array_slice(hexToShiftJIS(_array_tohexs(ret1)), 12, 10).join('');
    console.log('GID = ' + GID);
    communicateTitle.innerText = 'GID : ' + GID;
    
    return GID;
    }, (error) => {
      communicateTitle.innerText = 'Read error';
      throw(error);
   });
 
   let felica_read_without_encryption2 = new Uint8Array([16, 0x06, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 1, 0x0b,0x01, 1, 0x80,0x01]);//半角カナ氏名ブロック取得
               _array_copy(felica_read_without_encryption2, 2, card.idm, 0, card.idm.length);
   let response2 = await lib.communicateThru(felica_read_without_encryption2, 100, detectOption)
   .then(ret2 => {
    //communicateTitle.innerText = 'Reading...';
    console.log(/*communicateMessage.innerText = */'Send    : ' + _array_tohexs(felica_read_without_encryption2) +
                 '\nReceive : ' + _array_tohexs(ret2));
    kanaName = _array_slice(hexToShiftJIS(_array_tohexs(ret2)), 12, 10).join('');
    console.log('kanaName = ' + kanaName);
    communicateMessage.innerText = 'kanaName : ' + kanaName;
    return ret2;

   }, (error) => {
      communicateTitle.innerText = 'Read error';
      throw(error);
   });
  
   /* close() */
   await lib.close();
   lib = null;

  } catch(error) {
   console.log('Error errorType : ' + error.errorType);
   console.log('      message : ' + error.message);

   if (lib != null) {
    await lib.close();
    lib = null;
   }
  }

 if(GID.length == 10) {
   console.log('GID obtained:', GID);
  if (localStorage.FlagID === 'CONTROL') {// 管理者メニューへの遷移      
       //console.log('Navigating to /control_menu.html');
       const AdminStatus = await checkAdministratorExist(GID);
       if (AdminStatus === null) {
           communicateMessage.innerText = '管理者情報の取得に失敗しました。';
           console.error('Failed to check administrator existence for GID:', GID);
           return;
       }
      if (!AdminStatus.exists) {
           // communicateMessage.innerText = 'この社員番号は管理者に登録されていません。管理者登録してからご利用下さい。';
            console.error('GID not found in administrators:', GID);
            showCustomAlert('この社員番号は管理者に登録されていません。\n 管理者登録してからご利用下さい。', 1, function() {
                window.location.href = '/'; // メインメニュー画面へ遷移
                return;
            });
            /*showCustomAlert('この社員番号は管理者に登録されていません。 管理者登録してからご利用下さい。 今、管理者登録しますか？', 2, function(result) { 
                if (result === 'yes'){
                  window.location.href = '/register_administrator.html'; // 管理者登録画面へ遷移
                  return;              
                } else if (result === 'no') {
                  window.location.href = '/'; // メインメニューへ遷移
                  return;
               };
            });*/
       } else {
           //communicateMessage.innerText = `GID: ${GID} は管理者に登録されています。`;
           console.log('GID found in t03_administrators:', GID);
           window.location.href = '/control_menu.html';
           return;
          }
  } else if (localStorage.FlagID === 'ADMINISTRATOR') { 
        window.location.href = '/register_administrator.html'; // 管理者登録画面へ遷移
        return;
  } else if (GID.startsWith('ZP')/*| GID === '0000920442'*/) { // ZP社員証の場合t02_usersテーブルでユーザー情報を取得 
        const userStatus = await checkUserExist(GID);
        if (userStatus === null) {
            communicateMessage.innerText = 'ユーザー情報の取得に失敗しました。';
            console.error('Failed to check user existence for GID:', GID);
            return;
       } else if (!userStatus.exists) {
            communicateMessage.innerText = 'この社員番号はユーザーに登録されていません。ユーザー登録してからご利用下さい。';
            console.error('GID not found in t02_users:', GID);
            showCustomAlert('この社員番号はユーザーに登録されていません。 ユーザー登録してからご利用下さい。 今、ユーザー登録しますか？', 2, function(result) { 
                if (result === 'yes'){
                  window.location.href = '/register_user.html'; // ユーザー登録画面へ遷移
                  return;              
                } else if (result === 'no') {
                  window.location.href = '/'; // メインメニューへ遷移
                  return;
               };
            });

            return;
        } else {
            //communicateMessage.innerText = `GID: ${GID} はユーザーに登録されています。`;
            console.log('GID found in t02_users:', GID);
            window.location.href = '/scan_QRcode.html'; //ユーザー登録済ならQRコード画面へ遷移
            return
        }
   } else if (GID.startsWith('ZV')) { 
        showCustomAlert('ビジターカードではご利用できません。', 1, function() {
            window.location.href = '/'; // メインメニューへ遷移
            return;
        });
   } else if (GID.startsWith('ZO')) {
        showCustomAlert('One Dayカードではご利用できません。', 1, function() {
            window.location.href = '/'; // メインメニューへ遷移
            return;
        });
   } else {//ZP社員証以外の社員証はLDAPサーバーでメルアドを取得する。
   // サーバーサイドのAPIエンドポイントを呼び出す
   fetch(`/api/ldap_user/${GID}`)
        .then(response => {
       if (!response.ok) {
         // HTTPエラーレスポンス (400, 500など)
         return response.json().then(errorData => {
           throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error || response.statusText}`);
         });
       }
       return response.json();
     })
     .then(userInfo => {
       console.log('LDAP User Info from API:', userInfo);// レスポンスをコンソールに出力
       // ここで取得したuserInfo (JSONオブジェクト) を利用してHTMLを更新するなどします。
       // 例: communicateMessage.innerText = `Mail: ${userInfo.mail}, DisplayName: ${userInfo.displayName}`;
       if (userInfo.success) {
           communicateMessage2.innerText = `eMail: ${userInfo.mail || 'N/A'}`;
           console.log('LDAP User Info:', userInfo);
          // GIDとeMailをlocalStorageに保存
           localStorage.setItem('GID', GID);
           localStorage.setItem('eMail', userInfo.mail || '');
           // LDAP認証成功時にQRコード画面へ遷移
           window.location.href = '/scan_QRcode.html';
       } else {
           communicateMessage.innerText = `LDAP情報取得失敗: ${userInfo.error}`;
           console.error('LDAP API Error:', userInfo.error);
       }
     })
     .catch(error => {
       console.error('Error fetching LDAP user info:', error);
       communicateMessage.innerText = `LDAP情報取得エラー: ${error.message}`;
     });
    }
   console.log('[Reading a FeliCa Card] End');
   break; // GIDが取得できたらループを終了
  }
  await sleep(100); // カードが検出されない場合は少し待つ
 } while (true); // カードが検出されるまでループ
 return;

 }

async function checkAdministratorExist(gid) {
  const res = await fetch(`/api/check_administrator_exists/${encodeURIComponent(gid)}`);
  if (!res.ok) return null;
  return await res.json();// exists: True/False
}
async function checkUserExist(gid) {
  const res = await fetch(`/api/check_user_exists/${encodeURIComponent(gid)}`);
  if (!res.ok) return null;
  return await res.json();// exists: True/False
}

 function _def_val(param, def){
  return (param === undefined) ? def : param;
 }
 function _array_slice(array, offset, length){
  let result;
  length = _def_val(length, array.length - offset);
  result = [];
  _array_copy(result, 0, array, offset, length);
  return result;
 }
 function _bytes2hexs(bytes, sep) {
  let str;
  sep = _def_val(sep, ' ');
  return bytes.map(function(byte) {
   str = byte.toString(16);
   return byte < 0x10 ? '0'+str : str;
  }).join(sep).toUpperCase();
 }
 function _array_tohexs(array, offset, length){
  let temp;
  offset = _def_val(offset, 0);
  length = _def_val(length, array.length - offset);
  temp = _array_slice(array, offset, length );
  return _bytes2hexs(temp, '');
 }
 function _array_copy(dest, dest_offset, src, src_offset, length){
  let idx;
  src_offset = _def_val(src_offset, 0);
  length = _def_val(length, src.length);

  for (idx = 0; idx < length; idx++) {
   dest[dest_offset + idx] = src[src_offset + idx];
  }
  return dest;
 }

    function hexToShiftJIS(hexString) {
        let bytes = [];
        for (let i = 0; i < hexString.length; i += 2) {
          const hexByte = hexString.substring(i, i + 2);
          bytes.push(parseInt(hexByte, 16));
        }
        return new TextDecoder('Shift-JIS').decode(new Uint8Array(bytes));
    }
 async function sleep(msec) {
  return new Promise(resolve => setTimeout(resolve, msec));
   }
</script>

</body>
</html>
