<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>QRコードスキャン</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            position: relative;
            background: #f8f8f8;
        }
        .center-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 400px;
            max-height: 400px;
        }
        .main-menu-btn {
            position: absolute;
            left: 40px;
            bottom: 40px;
            padding: 12px 32px;
            font-size: 1.1em;
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .input-box {
            position: absolute;
            top: 30px;
            right: 40px;
        }
        .input-box input[type="text"] {
            font-size: 1.2em;
            padding: 6px 12px;
            width: 220px;
        }
    </style>
</head>
<body>
    <!-- 右上テキストボックス -->
    <div class="input-box">
        <input type="text" id="externalInput" placeholder="外部入力を待機...">
    </div>
    <!-- 画面中央のQR画像 -->
    <img src="/static/images/ScanQRcode.jpg" alt="QRコードをスキャン" class="center-image">
    <!-- 左下のメインメニューボタン -->
    <button class="main-menu-btn" onclick="window.location.href='/'">メインメニュー</button>
    <!-- 共通カスタムメッセージボックスをインクルード -->
    {% include 'my_messagebox.html' %}
    <script>
        // グローバル変数
        window.InstID = null;
        // ページ遷移時にテキストボックスへフォーカス
        window.onload = function() {
            const input = document.getElementById('externalInput');
            input.focus();
            // Enterキーまたは値入力時に遷移
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    handleInput();
                }
            });
            // 外部入力機器用にinputイベントも監視
            input.addEventListener('input', function(e) {
                // 連続入力や自動送信機器対応（必要に応じて条件調整）
                if (input.value.length > 0 && input.value.endsWith('\n')) {
                    input.value = input.value.replace(/\n/g, '');
                    handleInput();
                }
            });
        };
        async function checkLentStatus(instID) {
            const res = await fetch(`/api/check_lent_status?instid=${encodeURIComponent(instID)}`);
            if (!res.ok) return null;
            return await res.json();
        }
        async function handleInput() {
            const val = document.getElementById('externalInput').value.trim();
            if (!val) return;
            // 先頭3文字チェック
            if (val.startsWith('978') || val.startsWith('192')) {
                showCustomAlert('２段バーコードをスキャンしています。\nQRコードをスキャンして下さい。', 1, function() {
                    window.location.href = '/';
                });
                return;
            }
            window.InstID = val;
            const flag = localStorage.FlagQR;
            if (flag === 'LEND' || flag === 'RETURN') {
                const status = await checkLentStatus(val);
                if (flag === 'LEND' && status && status.exists) {
                    showCustomAlert('この書籍は貸出し中です。一旦返却処理を行うと貸出しできます。', 1, function() {
                        window.location.href = '/';
                    });
                    return;
                }
                if (flag === 'RETURN' && status && !status.exists) {
                    showCustomAlert('この書籍は返却済です。貸出しされていません', 1, function() {
                        window.location.href = '/';
                    });
                    return;
                }
            }
            // FlagQRによる遷移先分岐
            let nextUrl = '';
            if (flag === 'LENT') {
                nextUrl = `/exec_borrow.html?instid=${encodeURIComponent(val)}`;
            } else if (flag === 'RETURN') {
                nextUrl = `/exec_return.html?instid=${encodeURIComponent(val)}`;
            } else if (flag === 'SHELF') {
                nextUrl = `/show_shelfname.html?instid=${encodeURIComponent(val)}`;
            } else {
                // デフォルトはmain_menu画面
                nextUrl = `/exec_borrow.html?instid=${encodeURIComponent(val)}`;
            }
            window.location.href = nextUrl;
        }
        // カスタムアラート関数
        function showCustomAlert(msg, flagButtons = 1, callback) {
          document.getElementById('customModalMsg').textContent = msg;
          // 全ボタン非表示
          ['customModalOk','customModalYes','customModalNo','customModalCancel'].forEach(id=>{
            document.getElementById(id).style.display = 'none';
          });
          // ボタン表示切替
          if(flagButtons === 1){
            document.getElementById('customModalOk').style.display = '';
          } else if(flagButtons === 2){
            document.getElementById('customModalYes').style.display = '';
            document.getElementById('customModalNo').style.display = '';
          } else if(flagButtons === 3){
            document.getElementById('customModalYes').style.display = '';
            document.getElementById('customModalNo').style.display = '';
            document.getElementById('customModalCancel').style.display = '';
          }
          document.getElementById('customModal').style.display = 'flex';

          // コールバック
          document.getElementById('customModalOk').onclick = function() {
            document.getElementById('customModal').style.display = 'none';
            if(callback) callback('ok');
          };
          document.getElementById('customModalYes').onclick = function() {
            document.getElementById('customModal').style.display = 'none';
            if(callback) callback('yes');
          };
          document.getElementById('customModalNo').onclick = function() {
            document.getElementById('customModal').style.display = 'none';
            if(callback) callback('no');
          };
          document.getElementById('customModalCancel').onclick = function() {
            document.getElementById('customModal').style.display = 'none';
            if(callback) callback('cancel');
          };
        }
    </script>
</body>
</html>
