<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>書籍データ登録</title>
    <style>
        body {
            font-family: sans-serif;
        }

        h1 {
            text-align: center;
        }

        form {
            width: 500px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
        }

        label {
            display: inline-block;
            width: 100px;
            text-align: right;
            margin-right: 10px;
        }

        input[type="text"],
        input[type="number"] {
            width: 300px;
            padding: 5px;
            border: 1px solid #ccc;
        }
        /* Readonly fields style - No longer needed for category, but kept for potential future use */
        input[readonly] {
            background-color: #eee;
        }

        button[type="button"] { /* Specificity increased */
            padding: 5px 10px;
            margin-left: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button[type="submit"] { /* Style for the register button */
             display: block;
             width: 100px;
             /* flex内配置に合わせ margin削減 */
             margin: 0;
             padding: 10px;
             background-color: #4CAF50;
             color: white;
             border: none;
             cursor: pointer;
        }
        .form-buttons { display:flex; justify-content:space-between; gap:40px; margin-top:25px; }
        .form-buttons button { flex:1; max-width:180px; padding:10px; height:44px; display:flex; align-items:center; justify-content:center; }
        .btn-menu { background:#6c757d; color:#fff; border:none; cursor:pointer; }

        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            width: 200px;
        }
        .location-select-container {
            position: absolute;
            top: 20px;
            right: 50px;
            width: 350px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .location-select-container label {
            font-size: 1.1em;
            color: #555;
        }
        .location-select-container select {
            padding: 8px;
            width: 90%;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .isbn-row { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 12px; 
            margin-left: 60px; /* 左側に余白を追加して中央揃え */
        }
        .isbn-row label { 
            width: auto; 
            margin-right: 5px; 
        }
        #isbn { 
            width: 185px; 
        } 
    </style>
</head>
<body>
    <div class="location-select-container">
        <label for="locationSelect">場所:</label>
        <select id="locationSelect" name="location"></select>
    </div>
    <h1>書籍データ登録</h1>

    <form id="bookForm">
        <div class="isbn-row">
            <label for="isbn">ISBN:</label>
            <input type="text" id="isbn" name="isbn" style="ime-mode: inactive;">
            <button type="button" onclick="fetchBookInfo()">書籍情報取得</button>
        </div>
        <!-- 書影表示エリア -->
        <div id="thumbnailContainer" style="margin-top: 10px; text-align: center; min-height: 150px;">
            <img id="bookThumbnail" src="" alt="書影" style="max-width: 100px; max-height: 150px; display: none; border: 1px solid #ccc;">
            <p id="thumbnailMessage" style="display: none; margin-top: 5px; font-size: 0.9em; color: #666;"></p>
        </div>
        <br><br>

        <label for="title">タイトル:</label>
        <input type="text" id="title" name="title"><br><br>

        <label for="author">著者:</label>
        <input type="text" id="author" name="author"><br><br>

        <label for="publisher">出版社:</label>
        <input type="text" id="publisher" name="publisher" style="ime-mode: active;"><br><br>

        <label for="issueYear">発行年:</label>
        <input type="text" id="issueYear" name="issueYear"><br><br>

        <label for="price">価格:</label>
        <input type="number" id="price" name="price"><br><br>

        <label for="category">書籍分類:</label>
        <input type="text" id="category" name="category"><br><br>
        <div id="originalCategoryContainer" style="display: none;">
            <label for="originalCategory">独自分類:</label>
            <select id="originalCategory" name="originalCategory"></select><br><br>
        </div>

        <input type="hidden" id="thumbnail_exists" name="thumbnail_exists" value="false">
        <input type="hidden" id="hit_ndl" name="hit_ndl" value="false">

        <div class= "form-buttons">
            <button type="button" onclick="location.href='/control_menu.html'">管理メニュー</button>
            <button type="button" onclick="clearForm()">クリア</button>
            <button type="submit" onclick="registerBook(event)">登録</button>
        </div>
    </form>

    <h2>登録データ一覧</h2>
    <table id="bookTable">
        <thead>
            <tr>
                <th>InstanceID</th>
                <th>ISBN</th>
                <th>タイトル</th>
                <th>著者</th>
                <th>出版社</th>
                <th>発行年</th>
                <th>価格</th>
                <th>書籍分類</th> 
            </tr>
        </thead>
        <tbody>
        {% for book in books %}
            <tr>
                <td>{{ book.instance_id }}</td>
                <td>{{ book.isbn }}</td>
                <td>{{ book.title }}</td>
                <td>{{ book.author }}</td>
                <td>{{ book.publisher }}</td>
                <td>{{ book.issue_year }}</td>
                <td>{{ book.price }}</td>
                <td>{{ book.category_id }}</td>
            </tr>
        {% else %}
            <tr><td colspan="8" style="text-align:center; color:#888;">登録データはありません</td></tr>
        {% endfor %}
        </tbody>
    </table>
    {% include 'my_messagebox.html' %}

    <script>
        //コンボボックスによる場所選択
        var locationToRegister = ''; // t00テーブルに場所として登録する値を格納する変数
        var flagLoaded = false; // 初回ロード時のフラグ
        
        // 場所をt04_locationsテーブルのPC名から取得する関数
        async function getPcLocation() {      
            try {
                const response = await fetch('/api/get_location_by_serial');
                const result = await response.json();
                if (result.location) {
                    console.log('PCの場所が取得されました:', result.location)
                    return result.location;
                } else {
                    console.error('PCの場所の取得に失敗しました:', result.error);
                    return null;
                }
            } catch (error) {
                console.error('PCの場所の取得中に通信エラーが発生しました:', error);
                return null;
            }
        }

        async function checkLocationMatchAndPrompt(locationSelect) {
            const pcLocation = await getPcLocation();
            if (pcLocation) {
                // 初回ロード時またはPCの場所が取得できた場合、コンボボックスの初期値をPC名の場所に設定
                if (window.flagLoaded === false) { // 初期ロード時のみ設定
                    window.flagLoaded = true; // 初回ロードフラグをtrueに設定
                    locationSelect.value = pcLocation;
                }
                locationToRegister = locationSelect.value; // 現在選択されている場所を登録対象とする

                if (locationSelect.value !== pcLocation) {
                    showCustomAlert('選択した場所とPC名が一致しません。選択した場所で登録する場合「はい」、PC名の場所で登録する場合「いいえ」、登録を中止する場合「キャンセル」を押して下さい。', 3, async function(buttonClicked) {
                        if (buttonClicked === 'yes') {
                            locationToRegister = locationSelect.value;
                            console.log('選択した場所で登録を続行:', locationToRegister);
                        } else if (buttonClicked === 'no') {
                            locationToRegister = pcLocation;
                            locationSelect.value = pcLocation; // コンボボックスもPC名の場所に更新
                            console.log('PC名の場所で登録を続行:', locationToRegister);
                        } else {
                            window.location.href = '/';
                        }
                    });
                }
            } else {
                // PCの場所が取得できなかった場合、アラートを表示
                showCustomAlert('PCの場所の取得に失敗しました。手動で場所を選択してください。', 1);
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            let locationSelect = document.getElementById('locationSelect');
            try {
                const response = await fetch('/api/locations');
                const result = await response.json();

                if (result.success) {
                    result.locations.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc.location;
                        option.textContent = `${loc.location} (${loc.library_name})`;
                        locationSelect.appendChild(option);
                    });
                    locationSelect.focus();
                } else {
                    console.error('場所の取得に失敗しました:', result.error);
                    showCustomAlert('場所の取得に失敗しました: ' + result.error, 1);
                }
            } catch (error) {
                console.error('通信エラーが発生しました:', error);
                showCustomAlert('通信エラーが発生しました。', 1);
            }
            
            // ページロード時に場所の一致チェックとプロンプトを実行
            await checkLocationMatchAndPrompt(locationSelect);

            locationSelect.addEventListener('change', async function() {
                await checkLocationMatchAndPrompt(locationSelect);
                // 場所が選択されたときに、category_tableの値に基づいて独自分類を表示・非表示にする
                const selectedLocation = locationSelect.value;
                try {
                    const response = await fetch(`/api/location_category_table?location=${selectedLocation}`);
                    const result = await response.json();
                    if (result.success) {
                        const categoryTable = result.category_table;
                        const originalCategoryContainer = document.getElementById('originalCategoryContainer');
                        const originalCategorySelect = document.getElementById('originalCategory');

                        if (categoryTable !== 't07_categories_ndc') {
                            originalCategoryContainer.style.display = 'block';

                            // 独自分類の選択肢をクリア
                            originalCategorySelect.innerHTML = '';

                            // 独自分類の選択肢を取得
                            try {
                                const categoryResponse = await fetch(`/api/categories?table_name=${categoryTable}`);
                                const categoryResult = await categoryResponse.json();

                                if (categoryResult.success) {
                                    categoryResult.categories.forEach(category => {
                                        const option = document.createElement('option');
                                        option.value = category.category_id;
                                        option.textContent = `${category.category_id} (${category.category})`;
                                        originalCategorySelect.appendChild(option);
                                    });
                                } else {
                                    console.error('独自分類の取得に失敗しました:', categoryResult.error);
                                    showCustomAlert('独自分類の取得に失敗しました: ' + categoryResult.error, 1);
                                }
                            } catch (error) {
                                console.error('独自分類の取得中に通信エラーが発生しました:', error);
                                showCustomAlert('独自分類の取得中に通信エラーが発生しました。', 1);
                            }
                        } else {
                            originalCategoryContainer.style.display = 'none';
                        }
                    } else {
                        console.error('category_tableの取得に失敗しました:', result.error);
                        showCustomAlert('category_tableの取得に失敗しました: ' + result.error, 1);
                    }
                } catch (error) {
                    console.error('category_tableの取得中に通信エラーが発生しました:', error);
                    showCustomAlert('category_tableの取得中に通信エラーが発生しました。', 1);
                }
            });
        });

        
        // 国立国会図書館サーチAPIから書籍情報を取得する関数
        async function fetchBookInfo() {
            const isbn = document.getElementById("isbn").value.replace(/-/g, ''); // ハイフンを除去
            if (!isbn) {
                alert("ISBNを入力してください。");
                return;
            }

            // API実行前にフォームをクリア（ISBN以外）
            document.getElementById("title").value = "";
            document.getElementById("author").value = "";
            document.getElementById("publisher").value = "";
            document.getElementById("issueYear").value = "";
            document.getElementById("price").value = "";
            document.getElementById("category").value = "";

            // 書影表示エリアをクリア
            document.getElementById("bookThumbnail").style.display = "none";
            document.getElementById("bookThumbnail").src = "";
            document.getElementById("thumbnailMessage").style.display = "none";
            document.getElementById("thumbnailMessage").textContent = "";


            // SRU API のベース URL とパラメータ
            const baseUrl = "https://ndlsearch.ndl.go.jp/api/sru";
            const params = new URLSearchParams({
                operation: "searchRetrieve",
                version: "1.2",
                recordSchema: "dcndl", // DC-NDLスキーマを指定
                onlyBib: "true",
                recordPacking: "xml",
                // CQL クエリ: ISBN で検索し、データソースを NDL-OPAC に限定
                query: `isbn="${isbn}" AND dpid="iss-ndl-opac"`
            });
            const apiUrl = `${baseUrl}?${params.toString()}`;
            console.log("Request URL (SRU):", apiUrl); // デバッグ用にURLを出力

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");

                // 名前空間を解決するためのヘルパー関数 (SRU/DC-NDL 用に修正)
                const nsResolver = (prefix) => {
                    const ns = {
                        'sru': 'http://www.loc.gov/zing/srw/', // SRU 名前空間
                        'rdf': 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
                        'dcndl': 'http://ndl.go.jp/dcndl/terms/', // DC-NDL 名前空間
                        'dc': 'http://purl.org/dc/elements/1.1/',
                        'dcterms': 'http://purl.org/dc/terms/',
                        // 必要に応じて他の名前空間を追加
                    };
                    // デフォルト名前空間は SRU レスポンスでは通常不要なため削除
                    return ns[prefix] || null;
                };

                // XPathを使用して要素や属性を取得するヘルパー関数
                const evaluateXPath = (path, contextNode = xmlDoc, resultType = XPathResult.FIRST_ORDERED_NODE_TYPE) => {
                    return xmlDoc.evaluate(path, contextNode, nsResolver, resultType, null);
                };
                 const evaluateXPathAll = (path, contextNode = xmlDoc) => {
                    // Use ORDERED_NODE_ITERATOR_TYPE for iterating through multiple nodes
                    return xmlDoc.evaluate(path, contextNode, nsResolver, XPathResult.ORDERED_NODE_ITERATOR_TYPE, null);
                };


                // 書籍リソース要素を取得 (SRU/DC-NDL形式を想定)
                // SRUレスポンスの構造に合わせてXPathを修正
                const bibResourceNode = evaluateXPath("//sru:recordData/rdf:RDF/dcndl:BibResource", xmlDoc).singleNodeValue;

                if (!bibResourceNode) { // bibResourceNode をチェック
                    alert("該当する書籍情報が見つかりませんでした。");
                    return;
                }
                // 以降のXPathはこの bibResourceNode を基点にする
                const item = bibResourceNode; // 変数名を合わせる (もしくは bibResourceNode のまま使う)

                if (!item) {
                    alert("該当する書籍情報が見つかりませんでした。");
                    return;
                }

                // 各情報をXPathで取得 (DC-NDL スキーマに合わせて修正)
                // 注意: dcndl:BibResource (item) を基点とするため、XPath の先頭に '.' を付ける
                const titleNode = evaluateXPath("./dc:title", item).singleNodeValue;
                // 著者情報は dcndl:creator や dc:creator を確認 (複数ある可能性も考慮)
                const authorNode = evaluateXPath("./dcndl:creator | ./dc:creator", item).singleNodeValue; // まず最初のものを取得
                // 出版社取得の XPath をシンプルに変更
                const publisherNode = evaluateXPath("./dcterms:publisher", item).singleNodeValue;
                const issuedNode = evaluateXPath("./dcterms:issued", item).singleNodeValue; // 発行年 (YYYY または YYYY-MM-DD)
                const priceNode = evaluateXPath("./dcndl:price", item).singleNodeValue; // 価格

                // タイトル取得時に trim() と改行での分割を適用して本体のみ抽出
                const fullTitleText = titleNode?.textContent || "";
                console.log("Raw Title Text:", fullTitleText); // 元のテキストをログ出力
                // 改行で分割し、空でない最初の行を取得して trim()
                const title = fullTitleText.split('\n')
                                           .map(part => part.trim()) // 各行を trim
                                           .find(part => part !== '') || ""; // 空でない最初の行を見つける
                console.log("Processed Title:", title); // 処理後のタイトルをログ出力
                const author = authorNode?.textContent || ""; // 著者 (最初のもの)
                console.log("Author:", author);
                // 出版社名取得時に trim() と改行での分割を適用して本体のみ抽出
                const fullPublisherText = publisherNode?.textContent || "";
                console.log("Raw Publisher Text:", fullPublisherText); // 元のテキストをログ出力
                // 改行で分割し、空でない最初の行を取得して trim()
                const publisher = fullPublisherText.split('\n')
                                                   .map(part => part.trim()) // 各行を trim
                                                   .find(part => part !== '') || ""; // 空でない最初の行を見つける
                console.log("Processed Publisher:", publisher); // 処理後の出版社名をログ出力
                const issued = issuedNode?.textContent || "";
                const issueYear = issued.match(/^\d{4}/)?.[0] || ""; // YYYY または YYYY-MM-DD から年のみ抽出
                console.log("Issue Year:", issueYear);

                // --- 書籍分類 (NDC) 取得ロジック (XPath の基点を修正) ---
                let category = "";
                // XPath の基点を item (dcndl:BibResource) に変更
                const subjectIterator = evaluateXPathAll("./dcterms:subject[starts-with(@rdf:resource, 'http://id.ndl.go.jp/class/ndc10/') or starts-with(@rdf:resource, 'http://id.ndl.go.jp/class/ndc9/')]", item);
                console.log("Subject Iterator:", subjectIterator);
                let subjectNode;
                console.log("Attempting to iterate subjects...");
                while (subjectNode = subjectIterator.iterateNext()) {
                    console.log("Iterating a subject node...");
                    const resourceAttr = subjectNode.getAttributeNS('http://www.w3.org/1999/02/22-rdf-syntax-ns#', 'resource');
                    console.log("Resource Attribute:", resourceAttr);
                    if (resourceAttr) {
                        const parts = resourceAttr.split('/');
                        console.log("Resource Parts:", parts);
                        const ndcCode = parts[parts.length - 1];
                        console.log("NDC Code:", ndcCode);
                        if (ndcCode && /^\d/.test(ndcCode)) {
                            category = ndcCode.charAt(0);
                            console.log("Extracted Category:", category);
                            break;
                        }
                    }
                }
                // --- 書籍分類取得ロジックここまで ---

                // 価格 (空なら0)
                let price = 0;
                const priceValue = priceNode?.textContent || "";
                console.log("Price Value:", priceValue);
                if (priceValue !== "") {
                    // 価格文字列から数値のみを抽出 (例: "1800円" -> 1800)
                    const priceMatch = priceValue.match(/\d+/);
                    if (priceMatch) {
                        const parsedPrice = parseInt(priceMatch[0], 10);
                        if (!isNaN(parsedPrice)) {
                            price = parsedPrice;
                        }
                    }
                }
                console.log("Parsed Price:", price);


                // フォームに値を設定
                document.getElementById("title").value = title;
                document.getElementById("author").value = author;
                document.getElementById("publisher").value = publisher;
                document.getElementById("issueYear").value = issueYear;
                document.getElementById("category").value = category; // Set category from extracted NDC first digit
                document.getElementById("price").value = price; // Set price

                // --- 書影表示処理 ---
                const thumbnailImg = document.getElementById("bookThumbnail");
                const thumbnailMsg = document.getElementById("thumbnailMessage");
                const thumbnailUrl = `https://ndlsearch.ndl.go.jp/thumbnail/${isbn}.jpg`;

                // 画像が存在するか確認 (onerror イベントを利用)
                let thumbnailExistsFlag = false;
                thumbnailImg.onload = () => {
                    thumbnailImg.style.display = "block";
                    thumbnailMsg.style.display = "none";
                    thumbnailMsg.textContent = "";
                    thumbnailExistsFlag = true;
                    document.getElementById("thumbnail_exists").value = "true";
                };
                thumbnailImg.onerror = () => {
                    thumbnailImg.style.display = "none";
                    thumbnailMsg.style.display = "block";
                    thumbnailMsg.textContent = "書影が見つかりません。";
                    thumbnailExistsFlag = false;
                    document.getElementById("thumbnail_exists").value = "false";
                };
                // 既存の src をクリアしてから新しい URL を設定 (キャッシュ対策)
                thumbnailImg.src = "";
                thumbnailImg.src = thumbnailUrl;
                // --- 書影表示処理ここまで ---

                // NDLヒットフラグもhiddenにセット
                document.getElementById("hit_ndl").value = "true";

            } catch (error) {
                console.error("書籍情報の取得に失敗しました:", error);
                alert("書籍情報の取得中にエラーが発生しました。");
                // エラー時も書影エリアをリセット
                document.getElementById("bookThumbnail").style.display = "none";
                document.getElementById("bookThumbnail").src = "";
                document.getElementById("thumbnailMessage").style.display = "none";
                document.getElementById("thumbnailMessage").textContent = "";
            }
        }

        // 書籍データを登録する関数
        async function registerBook(event) {
            event.preventDefault(); // Prevent default form submission

            const isbn = document.getElementById("isbn").value;
            const title = document.getElementById("title").value;
            const author = document.getElementById("author").value;
            const publisher = document.getElementById("publisher").value;
            const issueYear = document.getElementById("issueYear").value;
            const price = document.getElementById("price").value;
            const category = document.getElementById("category").value; // Get category
            const ownCategorySelect = document.getElementById('originalCategory');
            const own_category_id = (document.getElementById('originalCategoryContainer').style.display !== 'none' && ownCategorySelect && ownCategorySelect.value) ? ownCategorySelect.value : null;

            // 入力値の検証
            if (!isbn) {
                alert("ISBNを入力してください（書籍情報取得ボタンを押すか、手動で入力してください）。");
                return;
            }
            if (price && isNaN(price)) {
                alert("価格は数値で入力してください。");
                return;
            }
            if (issueYear && isNaN(issueYear)) {
                alert("発行年は数値で入力してください。");
                return;
            }
            console.log('inside registerBook function - locationToRegister:', window.locationToRegister, 'own_category_id:', own_category_id);
            // API経由で登録
            try {
                const thumbnail_exists = document.getElementById("thumbnail_exists").value === "true";
                const hit_ndl = document.getElementById("hit_ndl").value === "true";
                const response = await fetch('/api/register_book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        isbn: isbn,
                        title: title,
                        author: author,
                        publisher: publisher,
                        issueyear: issueYear,
                        price: price,
                        category: category,
                        hit_ndl: hit_ndl,
                        location: window.locationToRegister,
                        own_category_id: own_category_id,
                        thumbnail_exists: thumbnail_exists
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('登録が完了しました。InstanceID: ' + result.instance_id);
                    window.location.reload();
                } else {
                    alert('登録に失敗しました: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                console.error("書籍情報の登録に失敗しました:", error);
                alert("書籍情報の登録中にエラーが発生しました。");
            }
        }

        // フォームをクリアする関数（場所選択状態は維持）
        function clearForm() {
            const form = document.getElementById('bookForm');
            // フォーム内要素リセット (locationSelect は form 外なので影響なし)
            form.reset();
            // ISBN もresetで消えるが念のため
            document.getElementById('isbn').value = '';
            document.getElementById('title').value = '';
            document.getElementById('author').value = '';
            document.getElementById('publisher').value = '';
            document.getElementById('issueYear').value = '';
            document.getElementById('price').value = '';
            document.getElementById('category').value = '';
            // 独自分類
            const originalCategoryContainer = document.getElementById('originalCategoryContainer');
            const originalCategorySelect = document.getElementById('originalCategory');
            if (originalCategoryContainer && originalCategoryContainer.style.display !== 'none' && originalCategorySelect) {
                originalCategorySelect.selectedIndex = -1; // 選択解除
            }
            // サムネイル関連
            const thumbnailImg = document.getElementById('bookThumbnail');
            const thumbnailMsg = document.getElementById('thumbnailMessage');
            thumbnailImg.style.display = 'none';
            thumbnailImg.src = '';
            thumbnailMsg.style.display = 'none';
            thumbnailMsg.textContent = '';
            // hidden フラグ
            document.getElementById('thumbnail_exists').value = 'false';
            document.getElementById('hit_ndl').value = 'false';
            // 位置は維持 (locationToRegister も変更なし)
        }
    </script>
</body>
</html>
